#!/bin/sh

set -e

delete() {
  if [ -f "${1}" ] ; then
    rm "${1}"
  fi
}

delete_service_files() {
  delete /etc/systemd/data-warehouse.service.wants/data-warehouse-app.service
  delete /lib/systemd/system/data-warehouse-app.service

  delete /etc/systemd/data-warehouse.service.wants/data-warehouse.path
  delete /lib/systemd/system/data-warehouse.path

  delete /etc/systemd/multi-user.target.wants/data-warehouse.service
  delete /lib/systemd/system/data-warehouse.service
}

delete_displace_files() {
  delete /etc/init/data-warehouse.conf
}

case "$1" in

  purge)
    delete_service_files
    delete_displace_files
    (systemctl daemon-reload >/dev/null 2>&1 || :)
    (systemctl reset-failed >/dev/null 2>&1 || :)
  ;;

  remove)
    (systemctl -a -t service --no-legend  | awk '$1 ~ /data-warehouse/ { print $1 }' | xargs -I {} systemctl stop {} 2> /dev/null || :)
    delete_displace_files
    (systemctl daemon-reload >/dev/null 2>&1 || :)
  ;;

  upgrade|deconfigure)
    (systemctl stop data-warehouse >/dev/null 2>&1 || :)
  ;;

  remove|failed-upgrade|abort-install|abort-upgrade|disappear)
  ;;

  *)
    (>&2 echo "postrm called with unknown argument \`$1'")
    exit 1
  ;;

esac

exit 0
